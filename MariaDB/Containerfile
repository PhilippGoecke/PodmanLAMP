FROM debian:trixie-slim as install

ARG DEBIAN_FRONTEND=noninteractive

# set environment variables
ENV MYSQL_ROOT_PASSWORD=secret
ENV MYSQL_DATABASE=dbname
ENV MYSQL_USER=username
ENV MYSQL_PASSWORD=password

# install dependencies
RUN apt update && apt upgrade -y \
  && apt install -y --no-install-recommends --no-install-suggests mariadb-server \
  && rm -rf "/var/lib/apt/lists/*" \
  && rm -rf /var/cache/apt/archives

RUN mkdir /run/mysqld \
  && chown mysql:mysql /run/mysqld/

#RUN echo "CREATE USER 'root'@'%' IDENTIFIED BY '$MYSQL_ROOT_PASSWORD'; GRANT ALL PRIVILEGES ON *.* TO 'root'@'%'; FLUSH PRIVILEGES;" | mysql --host=localhost --password=$MYSQL_ROOT_PASSWORD

EXPOSE 3306

CMD ["mysqld", "--user=mysql", "--console", "--bind-address=0.0.0.0"]

HEALTHCHECK --interval=30s --timeout=10s --start-period=20s CMD mysqladmin ping -h localhost || exit 1
